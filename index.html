<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validação de Wind Shear - Previsor CIMAER</title>
    <style>
        /* Estilos consolidados e otimizados */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 850px;
            margin: 20px auto;
            padding: 0 20px;
            background-color: #f5f5f5;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
            margin-top: 20px;
        }

        .info-box {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .preview {
            background-color: #e0f2fe;
            padding: 1rem;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            margin: 1rem 0;
        }

        /* Demais estilos mantidos do código anterior */
        /* ... */
    </style>
</head>
<body>
    <div class="card">
        <h2>Validação de Wind Shear - Previsor CIMAER</h2>

        <!-- Reporte Original do EMS -->
        <div class="info-box">
            <h5>Reporte Recebido (EMS):</h5>
            <pre class="preview" id="emsReportPreview"></pre>
        </div>

        <!-- Formulário de Edição -->
        <form id="windShearForm">
            <!-- Cabeçalho e Validade -->
            <div class="form-row">
                <div class="form-group">
                    <label>Validade</label>
                    <div class="grid">
                        <input type="datetime-local" id="validityStart">
                        <input type="datetime-local" id="validityEnd" readonly>
                    </div>
                    <div class="button-group">
                        <button type="button" data-minutes="30">30 Min</button>
                        <button type="button" data-minutes="60">60 Min</button>
                        <button type="button" data-minutes="120">120 Min</button>
                    </div>
                </div>
            </div>

            <!-- Mensagem Codificada -->
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h5>Mensagem WS WRNG</h5>
                    <button type="button" id="toggleEditBtn">Editar Manualmente</button>
                </div>
                <pre class="preview" id="messagePreview"></pre>
                <textarea class="hidden" id="manualMsg"></textarea>
            </div>

            <!-- Demais campos do formulário mantidos -->
            <!-- ... -->
        </form>
    </div>

    <script>
        // Estado inicial com dados do Reporte EMS
        const initialState = {
            emsReport: `FENÔMENO: WS (SEV)
ORIGEM: REP AT 1210 | AERONAVE: B747
LOCALIZAÇÃO: APCH RWY12
DADOS: SFC WIND 25015KT | LOSS 30KT | GAIN 25KT`,

            // Demais campos do state mantidos
            // ...
        };

        // Função para parsear o Reporte EMS
        function parseEMSReport(reportText) {
            const lines = reportText.split('\n');
            const result = {};
            
            lines.forEach(line => {
                const [key, value] = line.split(':').map(s => s.trim());
                switch(key) {
                    case 'FENÔMENO':
                        const [phen, severity] = value.split(' ');
                        result.phenomenon = phen;
                        if(severity) result.severity = severity.replace(/[()]/g, '');
                        break;
                    case 'ORIGEM':
                        if(value.includes('REP AT')) {
                            result.infoSource = ['REP'];
                            const [_, time, ac] = value.match(/REP AT (\d{4}) \| AERONAVE: (\w+)/) || [];
                            result.repTime = time;
                            result.repAC = ac;
                        }
                        break;
                    case 'LOCALIZAÇÃO':
                        const [loc, rwy] = value.split(' ');
                        result.localization = [loc];
                        result.rwy = rwy.replace('RWY', '');
                        break;
                    case 'DADOS':
                        value.split('|').forEach(item => {
                            const [key, val] = item.trim().split(' ');
                            if(key === 'SFC WIND') result.surfaceWind = val.replace('KT', '');
                            if(key === 'LOSS') result.loss = val.replace('KT', '');
                            if(key === 'GAIN') result.gain = val.replace('KT', '');
                        });
                        break;
                }
            });
            
            return result;
        }

        // Atualização do State inicial
        const state = {
            ...initialState,
            ...parseEMSReport(initialState.emsReport),
            validityStart: new Date().toISOString().slice(0, 16),
            validityEnd: ''
        };

        // Função de geração da mensagem WS WRNG
        function generateWRNGMessage() {
            const start = formatTimestamp(state.validityStart);
            const end = formatTimestamp(state.validityEnd);
            
            return `${state.location} WS WRNG 4 ${start}
VALID ${start}/${end}
${state.severity} WS IN ${state.localization} RWY${state.rwy}
SFC WIND: ${state.surfaceWind}KT
LOSS: ${state.loss}KT GAIN: ${state.gain}KT`;
        }

        // Função para atualização bidirecional
        function syncFields() {
            // Atualiza campos do formulário
            document.getElementById('repTime').value = state.repTime;
            document.getElementById('repAC').value = state.repAC;
            document.getElementById('rwy').value = state.rwy;
            
            // Atualiza previews
            document.getElementById('emsReportPreview').textContent = state.emsReport;
            document.getElementById('messagePreview').textContent = generateWRNGMessage();
        }

        // Event listeners para edição bidirecional
        document.getElementById('messagePreview').addEventListener('dblclick', () => {
            document.getElementById('toggleEditBtn').click();
        });

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            syncFields();
            calculateValidityEnd();
        });

        // Demais funções mantidas com ajustes
        // ...
    </script>
</body>
</html>
